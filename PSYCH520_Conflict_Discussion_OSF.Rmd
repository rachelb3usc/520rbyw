---
title: "PSYCH520_CD"
output: html_document
---

```{r, include=FALSE}
knitr::opts_chunk$set(fig.width=2, fig.height=2, fig.align = "center")
```

## Packages
```{r load-pkg, message=FALSE, warning=FALSE}
library(tidyverse) 
library(readr)
library(psych) 
library(dplyr)
library(tidyr)
library(irr)
library(boot)
```

## Load Data
```{r load-data, message=FALSE}
cd.pn <- read_csv("~/Documents/Yael/PhD/classes/Spring2025/stats psych 520 measuremennt/Final_Project/spaff.couples.1-100_updated.csv")
```

## Cohen's Kappa Analyes
```{r}
# Compute Cohen's Kappa for mom
mom_kappa <- kappa2(cd.pn[, c("behav_mom_RA1", "behav_mom_RA2")])
print(mom_kappa)
kappa_mom_val <- mom_kappa$value
z_mom <- mom_kappa$statistic

# Compute Cohen's Kappa for dad
dad_kappa <- kappa2(cd.pn[, c("behav_dad_RA1", "behav_dad_RA2")])
print(dad_kappa)
kappa_dad_val <- dad_kappa$value
z_dad <- dad_kappa$statistic

# Compute Standard Error
se_mom <- kappa_mom_val / z_mom
se_dad <- kappa_dad_val / z_dad

# 95% Confidence Intervals
ci_mom_lower <- kappa_mom_val - 1.96 * se_mom
ci_mom_upper <- kappa_mom_val + 1.96 * se_mom

ci_dad_lower <- kappa_dad_val - 1.96 * se_dad
ci_dad_upper <- kappa_dad_val + 1.96 * se_dad

cat("Mom Kappa 95% CI: [", round(ci_mom_lower, 3), ",", round(ci_mom_upper, 3), "]\n")
cat("Dad Kappa 95% CI: [", round(ci_dad_lower, 3), ",", round(ci_dad_upper, 3), "]\n")

```

## Compare Mom's vs. Dad's Cohen's Kappa 
```{r}
# Set sample sizes
n_mom <- 96
n_dad <- 96

# Fisher Z transformations
z_mom_fisher <- 0.5 * log((1 + kappa_mom_val) / (1 - kappa_mom_val))
z_dad_fisher <- 0.5 * log((1 + kappa_dad_val) / (1 - kappa_dad_val))

# Standard errors for Fisher Z
se_mom_fisher <- 1 / sqrt(n_mom - 3)
se_dad_fisher <- 1 / sqrt(n_dad - 3)

# Z test for difference
z_diff <- (z_mom_fisher - z_dad_fisher) / sqrt(se_mom_fisher^2 + se_dad_fisher^2)
p_value <- 2 * (1 - pnorm(abs(z_diff)))
cat("z =", round(z_diff, 2), "\n")
cat("p-value =", round(p_value, 4), "\n")

# 95% CI for difference
se_diff <- sqrt(se_mom_fisher^2 + se_dad_fisher^2)
lower_z <- (z_mom_fisher - z_dad_fisher) - 1.96 * se_diff
upper_z <- (z_mom_fisher - z_dad_fisher) + 1.96 * se_diff
lower_kappa <- (exp(2 * lower_z) - 1) / (exp(2 * lower_z) + 1)
upper_kappa <- (exp(2 * upper_z) - 1) / (exp(2 * upper_z) + 1)

cat("95% CI for difference in Kappas: [", round(lower_kappa, 3), ",", round(upper_kappa, 3), "]\n")
```
